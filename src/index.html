<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>webpack-minimal</title>
    <style>
     .sg-wrap {
         position: relative;
         margin: auto;
         width: 90%;
         height: 0;
         padding-bottom: 90%;
     }
     .controls {
         margin: auto;
         display: flex;
         flex-flow: column nowrap;
     }
    </style>
    <link rel="stylesheet" href="./assets/piece-css/pixel.css"/>
</head>
<body>
<section>
  <div id="app" class="is2d"></div>

  <div class="hud">
    <p> <span> Level </span> <span id="level">?</span>
      <span> Status </span> <span id="isend"> ? </span> 
      <span> Legal moves </span>
      <span id="legals">?</span>
    </p>
  </div>

  <div class="controls">
    <div class="self">
      <label>Level Set</label> <select id="levelSets"></select>
      <button id="prevLevel"> Previous Level </button>
      <button id="nextLevel"> Next Level </button>
      <button id="selfplay"> Start Self Play </button>
    </div>

    <div class="ai">
      <button id="aiplay"> Start AI Play </button>
      <label>Search Time</label>
      <input id="searchTime" type="range" min="100", max="60000" step="100" value="1000"></input>
    </div>
    <br/>
  </div>


</section>

<script>

 var level = 1;

 var testFen2 =
   "####################\n" +
   "####################\n" +
   "####################\n" +
   "#########.##########\n" +
   "#########$##########\n" +
   "######### ##########\n" +
   "###.$    @    $.####\n" +
   "####################\n" +
   "######### ##########\n" +
   "####################\n" +
   "####################\n";


 var testFen3 =  // 2000
   "####################\n" +
   "#########.##########\n" +
   "######### ##########\n" +
   "######### $     ####\n" +
   "###.   ##@     .####\n" +
   "####################\n";



 var testFen4 = // 3000
   "####################\n" +
   "#########.##########\n" +
   "#########      #####\n" +
   "#########    $  ####\n" +
   "###.   ##@      ####\n" +
   "####################\n";

 var testFen5 = // 3000
   "####################\n" +
   "#########.##########\n" +
   "#########$ .$  #####\n" +
   "#########       ####\n" +
   "###.   ##@      ####\n" +
   "####################\n";

 var testFen6 = // 4000
   "####################\n" +
   "#########.##########\n" +
   "#########  .$  #####\n" +
   "#########   $   ####\n" +
   "###.   ##@      ####\n" +
   "####################\n";

 var testFen7 = // 4000
   "####################\n" +
   "#########.##########\n" +
   "#########  .$  #####\n" +
   "#########   $   ####\n" +
   "###.   ##@      ####\n" +
   "####################\n";

 var seconds = 1000
 var minutes = 60 * seconds
 var hour = 60 * minutes;

 var kSearchTime = 10  * seconds;

 function initAiPlay(sokoban) {

   let stopLaterTimeoutId;
   let isRunning = false;

   let initialFen,
       moves;
   function onBestMove(move) {
     sokoban.move(move);
     moves.push(move);
     setTimeout(() => {
       if (!stopLaterTimeoutId) {
         engine.stop();
         engine.setPosition(initialFen, moves);
         engine.go({
           searchDeadline: kSearchTime
         });
       } else {
         clearTimeout(stopLaterTimeoutId);
         stopLaterTimeoutId = undefined;
         isRunning = false;
       }
     }, 0);
   }

   function reset() {
     initialFen = sokoban.getFen();
     moves = [];
     engine.setPosition(initialFen, moves);
     engine.go({
       searchDeadline: kSearchTime
     });
   }
   
   var engine = new Sokoban.Engine(onBestMove, {});

   return {
     isRunning() {
       return isRunning && !stopLaterTimeoutId;
     },
     startStop() {
       console.log('is running', isRunning, stopLaterTimeoutId);
       if (stopLaterTimeoutId) {
         
       } else if (isRunning) {
         stopLaterTimeoutId = setTimeout(() => {
           isRunning = false;
           stopLaterTimeoutId = undefined
         }, 1000);
         engine.stop();
       } else {
         isRunning = true;
         reset();
       }
     }
   }
 }

 function initSelfPlay(sokoban) {
   var isRunning = false;

   var loop = new Sokoban.SelfPlayLoop({
     searchDeadline: 1000,
     fen: sokoban.getFen()
   });

   return {
     isRunning() {
       return isRunning;
     },
     start() {
       if (!isRunning) {
         isRunning = true;
         loop.run();         
       }
     }
   };
 }

 const initSokoban = levels => {
   var opts = {
     levels,
     level: 1,
     // fen: testFen7,
     events: {
       move() {
         renderHud(level, sokoban);
       }
     }
   };

   var sokoban = Sokoban(document.getElementById('app'), opts);

   const aiApi = initAiPlay(sokoban);
   const selfPlayApi = initSelfPlay(sokoban);

   renderHud(level, sokoban);

   const unbinds = [];

   unbinds.push(onClick(document.getElementById('aiplay'), () => {
     aiApi.startStop();
     renderAiPlay(aiApi.isRunning());
   }));

   unbinds.push(onClick(document.getElementById('nextLevel'), () => {
     level = level === levels.length ? 1 : level + 1;
     renderHud(level, sokoban);
     sokoban.set({
       level: level
     });
     if (aiApi.isRunning()) {
       aiApi.startStop();
       renderAiPlay(aiApi.isRunning());
     }
   }));

   unbinds.push(onClick(document.getElementById('prevLevel'), () => {
     level = level === 1 ? levels.length : level - 1;
     renderHud(level, sokoban);
     sokoban.set({
       level: level
     });
     if (aiApi.isRunning()) {
       aiApi.startStop();
       renderAiPlay(aiApi.isRunning());
     }
   }));

   unbinds.push(onClick(document.getElementById('selfplay'), () => {
     selfPlayApi.start();
   }));

   unbinds.push(unbindable(document.getElementById('searchTime'), 'input', function() {
     kSearchTime = parseInt(this.value);
     aiApi.startStop();
     renderAiPlay(aiApi.isRunning());
   }));

   return () => {
     if (aiApi.isRunning()) {
       aiApi.startStop();
     }
     unbinds.forEach(f => f());
   }
 }
 
 function renderHud(level, sokoban) {
   renderLevel(level);
   renderLegals(sokoban.getLegalMoves());
   renderIsEnd(sokoban.isEnd()?"is end":
               sokoban.isStuck()?"is stuck":
               "is playing");
 }

 function renderIsEnd(str) {
   document.getElementById('isend').innerHTML = str;
 }

 function renderLegals(legals) {
   document.getElementById('legals').innerHTML = legals;
 }

 function renderLevel(level) {
   document.getElementById('level').innerHTML = level;
 }

 function renderAiPlay(isRunning) {
   let status = isRunning ? 'Stop': 'Start';

   document.getElementById('aiplay').innerHTML = status + ' AI Play';
 }

 function onClick(el, f) {
   return unbindable(el, 'click', f);
 }

 function unbindable(el, eventName, callback) {
   el.addEventListener(eventName, callback);
   return () => el.removeEventListener(eventName, callback);
 }

 function onChange(el, f) {
   el.addEventListener('change', f);
 }

 function addOption(el, value) {
   const $option = document.createElement('option');
   $option.value = value;
   $option.innerHTML = value;
   el.appendChild($option);
 }

 function makeStorage(name) {
   let val;
   return {
     get() {
       return val;
     },
     set(value) {
       val = value;
     }
   }
 }

 const customLevelsStorage = makeStorage('customlevels');

 function getCustomLevels() {
   let levels = customLevelsStorage.get();

   if (!levels) {
     customLevelsStorage.set(initialCustomLevels);
     return getCustomLevels(level);
   }

   return levels;
 }

 function setCustomLevel(level, fen) {
   let levels = customLevelsStorage.get();
   levels[level] = fen;
   customLevelsStorage.set(levels);
 }

 function getSelectedLevelSet(el, levelSets) {
   const name = el.options[el.selectedIndex].value;
   if (name === 'Custom') {
     return getCustomLevels();
   } else {
     return levelSets[name];
   }
 }

 const customLevel = `
####################
####################
########## . #######
########## $ #######
########## @ #######
####################
####################
####################
####################
####################`;
 const initialCustomLevels = [];
 for (var i = 0; i < 10; i++) {
   initialCustomLevels[i] = customLevel;
 }

 const levelSets = ['Original', 'Test'];

 Promise
   .all(levelSets.map(_ =>
     Sokoban
       .loadLevels('./assets/'+_+'.json')
       .then(ls => ([_, ls]))
   ))
   .then(levelSets => {
     levelSets = levelSets
       .reduce((acc, _) => ({ [_[0]]: _[1], ...acc }), {});

     const $elLevelSet = document.getElementById('levelSets');

     Object
       .keys(levelSets)
       .forEach(_ => addOption($elLevelSet, _));

     addOption($elLevelSet, 'Custom');

     $elLevelSet.selectedIndex = $elLevelSet.options.length - 1;

     var clearSokoban = initSokoban(getSelectedLevelSet($elLevelSet, levelSets));

     onChange($elLevelSet, (e) => {
       const levels = getSelectedLevelSet($elLevelSet, levelSets);

       if (clearSokoban) {
         clearSokoban();
       }
         clearSokoban = initSokoban(levels);
     });

   });
</script>

</body>
</html>
