<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>webpack-minimal</title>
    <style>
     .sg-wrap {
         position: relative;
         margin: auto;
         width: 90%;
         height: 0;
         padding-bottom: 90%;
     }
     .controls {
         margin: auto;
         display: flex;
         flex-flow: column nowrap;
     }
    </style>
    <link rel="stylesheet" href="./assets/piece-css/pixel.css"/>
</head>
<body>
<section>
  <div id="app" class="is2d"></div>

  <div class="hud">
    <p> <span> Level </span> <span id="level">?</span>
      <span> Status </span> <span id="isend"> ? </span> 
      <span> Legal moves </span>
      <span id="legals">?</span>
    </p>
  </div>

  <div class="controls">
    <div class="self">
      <button id="nextLevel"> Next Level </button>
      <button id="prevLevel"> Previous Level </button>
      <button id="selfplay"> Start Self Play </button>
    </div>

    <div class="ai">
      <button id="aiplay"> Start AI Play </button>
      <label>Search Time</label>
      <input id="searchTime" type="range" min="100", max="60000" step="100" value="1000"></input>
    </div>
    <br/>
  </div>


</section>

<script>

 var sokoban;
 var level = 1;

 var testFen2 =
   "####################\n" +
   "####################\n" +
   "####################\n" +
   "#########.##########\n" +
   "#########$##########\n" +
   "######### ##########\n" +
   "###.$    @    $.####\n" +
   "####################\n" +
   "######### ##########\n" +
   "####################\n" +
   "####################\n";


 var testFen3 =  // 2000
   "####################\n" +
   "#########.##########\n" +
   "######### ##########\n" +
   "######### $     ####\n" +
   "###.   ##@     .####\n" +
   "####################\n";



 var testFen4 = // 3000
   "####################\n" +
   "#########.##########\n" +
   "#########      #####\n" +
   "#########    $  ####\n" +
   "###.   ##@      ####\n" +
   "####################\n";

 var testFen5 = // 3000
   "####################\n" +
   "#########.##########\n" +
   "#########$ .$  #####\n" +
   "#########       ####\n" +
   "###.   ##@      ####\n" +
   "####################\n";

 var testFen6 = // 4000
   "####################\n" +
   "#########.##########\n" +
   "#########  .$  #####\n" +
   "#########   $   ####\n" +
   "###.   ##@      ####\n" +
   "####################\n";

 var testFen7 = // 4000
   "####################\n" +
   "#########.##########\n" +
   "#########  .$  #####\n" +
   "#########   $   ####\n" +
   "###.   ##@      ####\n" +
   "####################\n";

 var opts = {
   level: 1,
   // fen: testFen7,
   events: {
     move() {
       renderHud(level, sokoban);
     }
   }
 };

 var seconds = 1000
 var minutes = 60 * seconds
 var hour = 60 * minutes;

 var kSearchTime = 0.3  * seconds;

 function initAiPlay(sokoban) {

   let shouldStop = false;
   let isRunning = false;

   let initialFen,
       moves;
   function onBestMove(move) {
     sokoban.move(move);
     moves.push(move);
     setTimeout(() => {
       if (!shouldStop) {
         engine.stop();
         engine.setPosition(initialFen, moves);
         engine.go({
           searchDeadline: Date.now() + kSearchTime
         });
       } else {
         shouldStop = false;
         isRunning = false;
       }
     }, 0);
   }

   function reset() {
     initialFen = sokoban.getFen();
     moves = [];
     engine.setPosition(initialFen, moves);
     engine.go({
       searchDeadline: Date.now() + kSearchTime
     });
   }
   
   var engine = new Sokoban.Engine(onBestMove, {});

   return {
     isRunning() {
       return isRunning && !shouldStop;
     },
     startStop() {
       console.log('is running', isRunning);
       if (shouldStop) {
         
       }
       if (isRunning) {
         shouldStop = true;
         engine.stop();
       } else {
         isRunning = true;
         reset();
       }
     }
   }
 }

 function initSelfPlay(sokoban) {
   var isRunning = false;

   var loop = new Sokoban.SelfPlayLoop({
     searchDeadline: 1000,
     fen: sokoban.getFen()
   });

   return {
     isRunning() {
       return isRunning;
     },
     start() {
       if (!isRunning) {
         isRunning = true;
         loop.run();         
       }
     }
   };
 }

 Sokoban(document.getElementById('app'), opts, soko => {
   sokoban = soko;

   const aiApi = initAiPlay(sokoban);
   const selfPlayApi = initSelfPlay(sokoban);

   renderHud(level, sokoban);

   onClick(document.getElementById('aiplay'), () => {
     aiApi.startStop();
     renderAiPlay(aiApi.isRunning());
   });

   onClick(document.getElementById('nextLevel'), () => {
     level++;
     renderHud(level, sokoban);
     sokoban.set({
       level: level
     });
     if (aiApi.isRunning()) {
       aiApi.startStop();
       renderAiPlay(aiApi.isRunning());
     }
   });

   onClick(document.getElementById('prevLevel'), () => {
     level--;
     renderHud(level, sokoban);
     sokoban.set({
       level: level
     });
     if (aiApi.isRunning()) {
       aiApi.startStop();
       renderAiPlay(aiApi.isRunning());
     }
   });

   onClick(document.getElementById('selfplay'), () => {
     selfPlayApi.start();
   });

   document.getElementById('searchTime').oninput = function() {
     kSearchTime = parseInt(this.value);
     aiApi.startStop();
     renderAiPlay(aiApi.isRunning());
   };
 });

 function renderHud(level, sokoban) {
   renderLevel(level);
   renderLegals(sokoban.getLegalMoves());
   renderIsEnd(sokoban.isEnd()?"is end": "is playing");
 }

 function renderIsEnd(str) {
   document.getElementById('isend').innerHTML = str;
 }

 function renderLegals(legals) {
   document.getElementById('legals').innerHTML = legals;
 }

 function renderLevel(level) {
   document.getElementById('level').innerHTML = level;
 }

 function renderAiPlay(isRunning) {
   let status = isRunning ? 'Stop': 'Start';

   document.getElementById('aiplay').innerHTML = status + ' AI Play';
 }

 function onClick(el, f) {
   el.addEventListener('click', f);
 }
 
</script>

</body>
</html>
